# Default values for spiredb.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 3

image:
  repository: ghcr.io/spiredb/spiredb
  pullPolicy: Always
  # Overrides the image tag whose default is the chart appVersion.
  tag: "latest"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

rbac:
  # Specifies whether RBAC resources should be created
  create: true

# Network Policy Configuration
networkPolicy:
  # Enable NetworkPolicy (recommended for production)
  enabled: false  # Set to true to enforce network policies


podAnnotations: {}
podLabels: {}

podSecurityContext:
  fsGroup: 1000

securityContext:
  capabilities: {}
  runAsNonRoot: false
  runAsUser: 0

service:
  type: ClusterIP
  port: 6379
  # Metadata gRPC Port
  metadataPort: 50051
  # DataAccess gRPC Port
  dataAccessPort: 50052
  # Erlang Distribution Ports (Required for Clustering)
  epmdPort: 4369
  distPort: 9001

ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: chart-example.local
      paths:
        - path: /
          pathType: ImplementationSpecific
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local

resources:
  # Production ready defaults
  limits:
    cpu: 4
    memory: 8Gi
  requests:
    cpu: 2
    memory: 4Gi

# Storage configuration
persistence:
  enabled: true
  storageClass: "" # Host's default or specify NVMe class
  accessMode: ReadWriteOnce
  size: 100Gi

# Discovery and Cluster Configuration
discovery:
  # Method: "gossip" (K8s multicast), "k8sdns", or "static"
  type: "gossip"
  # For DNS discovery, the service name to query
  service: "spiredb-headless"

# Seed Node Configuration
seedNode:
  # Logic: spiredb-0 is always seed. Other nodes resolve its IP via DNS.
  # No configuration needed here.
  mode: "dynamic"


# SpireDB Server Configuration
# SpireDB Configuration
# Maps to SPIRE_* environment variables
config:
  dataDir: "/var/lib/spiredb" # Root data directory for volume mount
  logLevel: "info" # SPIRE_LOG_LEVEL
  
  # Placement Driver (PD)
  pd:
    numRegions: 16 # SPIRE_NUM_REGIONS
    startRaft: true # SPIRE_PD_START_RAFT
    dataDir: "/var/lib/spiredb/pd" # SPIRE_PD_DATA_DIR
    
  # Ra (Raft Lib)
  ra:
    dataDir: "/var/lib/spiredb/ra" # SPIRE_RA_DATA_DIR - Must be under /var/lib/spiredb (mounted volume)
    
  # Store - RESP / RocksDB / Raft
  store:
    # RESP Interface
    resp:
      maxConnections: 10000 # SPIRE_RESP_MAX_CONNECTIONS
      connectionTimeout: 60000 # SPIRE_RESP_CONNECTION_TIMEOUT
      
    # RocksDB
    rocksdb:
      path: "/var/lib/spiredb/data" # SPIRE_ROCKSDB_PATH
      maxOpenFiles: 10000 # SPIRE_ROCKSDB_MAX_OPEN_FILES
      
    # Raft Regions
    raft:
      dataDir: "/var/lib/spiredb/regions" # SPIRE_RAFT_DATA_DIR
      electionTimeout: 1000 # SPIRE_RAFT_ELECTION_TIMEOUT
      heartbeatInterval: 150 # SPIRE_RAFT_HEARTBEAT_INTERVAL
      # walMaxSize: calculated automatically in code if not set, or override here
      
  # Legacy/Other (kept for compatibility or future use if needed)
  segmentSize: "1073741824"
  compressionLevel: 3
  indexCacheSizeMB: 512
  oDirect: false
  compressionEnabled: false
  batchSize: 100
  rpcTimeoutMs: 1000
  rpcTimeoutMs: 1000
  connectTimeoutMs: 1000

  # Startup Diagnostics
  diag: false

nodeSelector: {}

tolerations: []

affinity:
  # Anti-affinity to ensure high availability (one pod per node)
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - spiredb
        topologyKey: kubernetes.io/hostname

# Init container to wait for DNS or perform setup? (Optional, not currently needed for DNS discovery)
initContainers: []
